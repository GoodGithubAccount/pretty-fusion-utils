local StringBuilder = require("../utils/string-builder")
local config = require("./config")
local fs = require("@lune/fs")
local mkdocs = require("./templates/mkdocs.yaml")
local path = require("../utils/path")
local process = require("@lune/process")
local serde = require("@lune/serde")
local stringer = require("../utils/stringer")

local PATH_DOCS = path(process.cwd, "docs")
local PATH_SRC = path(process.cwd, "src")
local TEMPLATE_INDEX = path(process.cwd, ".lune", "regenerate", "templates", "index.md")

local function reset(dir: string)
  if not fs.isDir(dir) then
    fs.writeDir(dir)
  else
    for _, file in fs.readDir(dir) do
      if fs.isFile(path(dir, file)) then
        fs.removeFile(path(dir, file))
      end
    end
  end
end

local utils = {}

for _, dir in fs.readDir(PATH_SRC) do
  local dirPath, configPath = path(PATH_SRC, dir), path(PATH_SRC, dir, "doc.toml")
  if not fs.isDir(dirPath) or not fs.isFile(configPath) then
    continue
  end

  local config = config.intoConfig(serde.decode("toml", fs.readFile(configPath))).config
  table.insert(utils, {
    dir = dir,
    config = config,
  })
end

table.sort(utils, function(first, second)
  return first.dir < second.dir
end)

local Regenerator = {}

function Regenerator.initFile()
  print("Regenerating init.luau exports")
  local initFile = StringBuilder()
    :appendLine("-- This file was autogenerated. It is not intended for manual editing.")
    :appendLine("-- Run `lune run regenerate` to generate a fresh init file.")
    :appendLine()
    :appendLine("return table.freeze {")
    :indent()

  for _, util in utils do
    print("Exporting", util.config.name)
    initFile:appendLine(util.config.name, "=", `require("src/{util.dir}"),`)
  end

  fs.writeFile(path(PATH_SRC, "init.luau"), initFile:unIndent():appendLine("}"):build())
end

function Regenerator.mkdocsConfig()
  print("Regenerating mkdocs.yaml navigation")
  local newMkdocs, nav: any = table.clone(mkdocs), {}
  table.insert(nav, "index.md")

  for _, util in utils do
    print("Adding navigation item", util.config.name)
    table.insert(nav, {
      [util.config.name] = `{util.dir}.md`,
    })
  end

  newMkdocs.nav = {
    {
      Home = nav,
    },
  }

  fs.writeFile(
    path(process.cwd, "mkdocs.yaml"),
    StringBuilder()
      :appendLine("# This file was autogenerated. It is not intended for manual editing.")
      :appendLine("# Run `lune run regenerate` to generate a fresh configuration file.")
      :appendLine()
      :appendLine("# Edit the configuration at `.lune/regenerate/templates/mkdocs.yaml.luau`")
      :appendLine()
      :appendLine(serde.encode("yaml", newMkdocs))
      :build()
  )
end

--[=[
  Regenerates MkDocs documentation, moonwave-esque documentation comments,
  README files for all utilities, and the init.luau export table. Each utility
  has a doc.toml file that configures how it is displayed.

  I may or may not need a psychological evaluation.
]=]
function Regenerator.regenerate()
  reset(PATH_DOCS)

  local firstList, secondList, indexUtils, pages = {}, {}, {}, {}
  for index, util in utils do
    print("Processing", util.config.name)

    local code = StringBuilder():append("function", util.config.name)
    local codeDocumentation = StringBuilder()
    local docComment = StringBuilder("--[=["):appendLine():indent():appendLine(util.config.brief)

    do
      if util.config.variadics then
        code:append(`<{table.concat(util.config.variadics, ", ")}>`)
      end
      code:appendLine("("):indent()

      if util.config.args then
        codeDocumentation
          :appendLine()
          :appendLine("---")
          :appendLine()
          :appendLine("## Arguments")
          :appendLine()
          :appendLine("| Name     | Type     | Description          |")
          :appendLine("| -------- | -------- | -------------------- |")

        local args = {}
        for _, arg in util.config.args do
          table.insert(args, `{arg.name}: {arg.type}`)
          codeDocumentation
            :append("|", arg.name, "|", `\`#!luau {arg.type}\``, "|", arg.description, "|")
            :appendLine()
          docComment:appendLine("@param", arg.name, stringer.cleanNewlines(arg.description))
        end
        code:appendLine(table.concat(args, ",\n"))
      end
      code:unIndent():append(")")

      if util.config.returns then
        code:append(": "):append(util.config.returns.type)
        docComment:appendLine("@return", stringer.cleanNewlines(util.config.returns.description))

        codeDocumentation
          :appendLine()
          :appendLine("---")
          :appendLine()
          :appendLine("## Returns")
          :appendLine()
          :appendLine("| Type     | Description                  |")
          :appendLine("| -------- | ---------------------------- |")
          :appendLine(
            "|",
            `\`#!luau {util.config.returns.type}\``,
            "|",
            util.config.returns.description,
            "|"
          )
      end

      if util.config.example then
        codeDocumentation
          :appendLine()
          :appendLine("---")
          :appendLine()
          :appendLine("## Example")
          :appendLine()
          :appendLine("```Luau")
          :appendLine(util.config.example)
          :appendLine("```")
      end
    end

    table.insert(
      index % 2 == 0 and firstList or secondList,
      StringBuilder("<li> <a ")
        :append(`href="{util.dir}">`)
        :append(util.config.name)
        :append("</a></li>")
        :build()
    )

    table.insert(
      indexUtils,
      StringBuilder("<section>\n")
        :appendLine(`<a href="./{util.dir}/">`)
        :appendLine("<h2>", util.config.name, "</h2>")
        :appendLine(util.config.brief)
        :appendLine("</a>")
        :appendLine("</section>")
        :build()
    )

    local usefulFor = StringBuilder()
    if util.config.useful_for then
      usefulFor:append("Useful for", util.config.useful_for)
    end

    local content = StringBuilder()
      :appendLine("<!-- This file was autogenerated. It is not intended for manual editing. -->")
      :appendLine("<!-- Run `lune run regenerate` to generate a fresh README. -->")
      :appendLine()
      :appendLine("#", util.config.name)
      :appendLine()
      :appendLine("```Luau")
      :appendLine(code:build())
      :appendLine("```")
      :appendLine()
      :appendLine(util.config.brief)
      :appendStringBuilder(usefulFor)
      :append(codeDocumentation:build())

    pages[util] = content:build()
    fs.writeFile(path(PATH_SRC, util.dir, "README.md"), content:build())

    local srcFilepath = path(PATH_SRC, util.dir, "init.luau")
    local srcFile = fs.readFile(srcFilepath)
    fs.writeFile(srcFilepath, (srcFile:gsub("%-%-%[=%[.*]=]", function()
      return docComment:append("]=]"):unIndent():build()
    end)))
  end

  table.sort(firstList)
  table.sort(secondList)
  table.sort(indexUtils)

  for util, content in pages do
    fs.writeFile(path(PATH_DOCS, `{util.dir}.md`), content)
  end

  Regenerator.initFile()
  Regenerator.mkdocsConfig()

  local index = fs.readFile(TEMPLATE_INDEX)
  index = index:gsub("%$utils%-grid", table.concat(indexUtils, "\n\n"))
  index = index:gsub("%$utils%-list%-1", table.concat(firstList, "\n\n"))
  index = index:gsub("%$utils%-list%-2", table.concat(secondList, "\n\n"))
  fs.writeFile(path(PATH_DOCS, "index.md"), index)
end

return Regenerator
